# Point charge approaches subbstrate (Na+ above Au(111))

variable dz             index 15.0  # initial distance between ion and substrate (ang)
variable substrate_type index 1     # type of substrate (Au)
variable ion_type       index 2     # type of ion (Na)
variable ion_charge     index 1.0   # charge of Na+ in "real units": elementary charge
variable vel            index -0.01 # approach velocity (ang/fs)
variable timestep       index 2.0   # fs
variable nsteps         equal "round( abs( v_dz / v_vel / v_timestep ) )"

units           real

atom_style      full

read_data       minimized.lammps

pair_style      coul/long/bsct 8.0
pair_coeff      * *
pair_modify     table 0
kspace_style    pppm/bsct 1.0e-4

neighbor        1.0 bin
neigh_modify    delay 0 every 1 check yes

timestep        ${timestep}

print           """
    Ion at initial distance dz = ${dz} ang approaches substrate
    at velocity v = ${vel} ang / fs over ${nsteps} time steps
    of ${timestep} fs each.
                """

group           substrate        type  ${substrate_type} # Au
group           ion              type  ${ion_type}       # Na+
group           bsct_atoms       union ion substrate

variable        nsubst  equal "count(substrate)"
variable        pcharge equal "-v_ion_charge / v_nsubst"

print           """
    Uniformly distribute counter charge Q = -${ion_charge} onto
    ${nsubst} substrate atoms at partial charge q = $(v_pcharge:%.4e) each
                """

set             group substrate charge ${pcharge}
set             group ion charge ${ion_charge}

# BSCT FIX SYNTAX
# fix groupID bsct atomType X U V p keyword values
# X: chemical potential; U: Hubbard energy; V: band structure contributuon; p: exponent
# Note that U cannot be "0"
fix             ct bsct_atoms bsct nevery 1 qtot 0.0 log 3 mode 2 history 10 &
                beta 0.1 prec 0.0001 max_iter 100 &
                type ${substrate_type} -1.0 1.0 0.0 2.0 &
                type ${ion_type}        1.0 1.0 0.0 2.0
fix_modify      ct energy yes

# fix             go     ion move linear 0.0 0.0 ${vel} units box
# fix           stay   substrate nve
# fix           freeze substrate setforce 0.0 0.0 0.0

thermo          1
thermo_style    custom step temp press etotal ke pe f_ct &
                ebond eangle edihed eimp epair evdwl ecoul elong etail
thermo_modify   format float %15.14g norm no

dump            1 all custom 1 dump.custom id mol type x y z q
dump_modify     1 format line "%d %d %d %f %f %f %15.14e %15.14e"

# run             ${nsteps}
run             1

write_data      final.lammps
write_dump      all image final.png type type modify backcolor white