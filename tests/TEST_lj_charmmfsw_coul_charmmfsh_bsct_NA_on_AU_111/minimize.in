# Modify and minimize

variable hvac     index 30.0 # desired height of vacuum
variable dz       index 15.0 # desired distance between ion and substrate
variable ion_type index 3    # type of ion (Na)

units           real

boundary        p p s

neigh_modify    delay 0 every 1 check yes

atom_style      full
bond_style      harmonic
angle_style     charmm
dihedral_style  charmmfsw
improper_style  harmonic

pair_style      lj/charmmfsw/coul/charmmfsh/bsct 8.0 12.0 9.0

special_bonds   charmm

read_data       relaxed.lammps extra/atom/types 1 group lower_electrode

print           "Lower electrode xlo xhi ylo yhi zlo zhi:"
print           "  $((xlo)) $((xhi))"
print           "  $((ylo)) $((yhi))"
print           "  $((zlo)) $((zhi))" 

# surface z coordinate
variable        z0 equal zhi
variable        zoffset equal "v_z0 + v_hvac" 

# intended position of ion:
variable        x1 equal $((xhi-xlo)/2.0)
variable        y1 equal $((yhi-ylo)/2.0)
variable        z1 equal $(v_z0 + v_dz)

read_data       relaxed.lammps add append offset 1 0 0 0 0 shift 0 0 ${zoffset} group upper_electrode

print           "Full system xlo xhi ylo yhi zlo zhi:"
print           "  $((xlo)) $((xhi))"
print           "  $((ylo)) $((yhi))"
print           "  $((zlo)) $((zhi))" 

# add arg = append or IDoffset or IDoffset MOLoffset or merge
#   append = add new atoms with atom IDs appended to current IDs
#   IDoffset = add new atoms with atom IDs having IDoffset added
#   MOLoffset = add new atoms with molecule IDs having MOLoffset added (only 
#               when molecule IDs are enabled)
#   merge = add new atoms with their atom IDs (and molecule IDs) unchanged
# offset args = toff boff aoff doff ioff
#   toff = offset to add to atom types
#   boff = offset to add to bond types
#   aoff = offset to add to angle types
#   doff = offset to add to dihedral types
#   ioff = offset to add to improper types
# shift args = Sx Sy Sz
#   Sx,Sy,Sz = distance to shift atoms when adding to system (distance units)
# group args = groupID
#   groupID = add atoms in data file to this group
# nocoeff = ignore force field parameters
# fix args = fix-ID header-string section-string
#   fix-ID = ID of fix to process header lines and sections of data file
#   header-string = header lines containing this string will be passed to fix
#   section-string = section names with this string will be passed to fix

# change_box      all z final $((zlo)) $((zhi+v_hvac))

group           ion              type  ${ion_type}     # Na+
group           bsct_atoms       union lower_electrode upper_electrode

thermo          1
thermo_style    custom step temp press etotal ke pe &
                ebond eangle edihed eimp epair evdwl ecoul elong etail
thermo_modify   format float %15.14g norm no

##############
# minimization
##############

### Minimze the potential energy here.
### minimize energy_tol force_tol maxiter maxeval
minimize        0.0 1.0e-6 1000 1000
# Require a force tolerance of ~ 10 Kcal/mole-Angstrom
# That should correspond to about 400 kJ / (mol*nm)

# Quote from http://lammps.sandia.gov/doc/minimize.html
# Perform an energy minimization of the system, by iteratively adjusting atom
# coordinates. Iterations are terminated when one of the stopping criteria is
# satisfied. At that point the configuration will hopefully be in local
# potential energy minimum. More precisely, the configuration should
# approximate a critical point for the objective function (see below), which
# may or may not be a local minimum.
#
#    etol = stopping tolerance for energy (unitless)
#    ftol = stopping tolerance for force (force units)
#    maxiter = max iterations of minimizer
#    maxeval = max number of force/energy evaluations
#
# Either or both of the etol and ftol values can be set to 0.0, in which case
# some other criterion will terminate the minimization.

print           "Insert ion at (x,y,z) = ( $((v_x1)), $((v_y1)), $((v_z1)) )"
create_atoms    ${ion_type} single $((v_x1)) $((v_y1)) $((v_z1))

write_data      minimized.lammps
write_dump      all image minimized.png type type modify backcolor white